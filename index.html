<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Ski Areas and Cities of the United States</title>
  <link rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
  html,
  body,

  #map {
    position: fixed;
    top: 0;
    bottom: 0;
    right: 0;
    width: 80%;
  }

  #side-panel {
    position: fixed;
    left: 0px;
    top: 0;
    bottom: 0;
    width: 20%;
    background-color: rgba(90, 90, 90, 0);
    overflow: hidden;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    font-family: 'Roboto', sans-serif;
    font-weight: 300;
  }
  </style>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js">
  </script>
</head>

<body>
  <div id="map"></div>
  <div id='side-panel'>
    <h1 style="position:relative; left:12%; top: 10px; font-weight: 700">Ski Areas and Cities</h1>

    <div style="position:absolute; left:10%; top: 9%; width:80%; height:4px; background-color:black; opacity:.3;"></div>

    <h2 style="position:absolute; left:10%; top: 7%; font-weight: 500"><br>About this map:</h2>
    <p style="position:absolute; left:12%; top: 14.4%; right: 10px; font-weight: 300">
      I created this map with the intent of <br>creating a
      tool to assist both experienced <br> and novice
      skiers in familiarizing <br> themselves with US ski
      areas and their <br> relative locations to major cities.</p>

    <div style="position:absolute; left:10%; top: 29%; width:80%; height:4px; background-color:black; opacity:.3;"></div>

    <h2 style="position:absolute; left:10%; top: 27%; font-weight: 500"><br>Tools:</h2>

    <div id='ui-data'>
      <label style="position:absolute; left:12%; top: 36%; right: 10px; font-weight: 300">Select Circle Scaling: </label>
      <select id="sector" style="position:absolute; left:12%; top: 38.5%; right: 10px; font-weight: 300">
        <option value="VIEWS" selected>Popularity (2020 Wikipedia pageviews)
        </option>
        <option value="VERT">Area Vertical</option>
      </select>
      <label style="position:absolute; left:12%; top: 43%; right: 10px; font-weight: 300">Select City Filter Values:</label>
      <select id="areacount" style="position:absolute; left:16%; top: 46%; right: 10px;">
        <option value="null" selected>X</option>
        <option value="1">1</option>
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="7">7</option>
        <option value="10">10</option>
      </select>
      <p style="position:absolute; left:28%; top: 44.3%; right: 10px; font-weight: 300">ski areas within</p>
      <select id="areadistance" style="position:absolute; left:16%; top: 49%; right: 10px; font-weight: 500">
        <option value="null" selected>Y</option>
        <option value="50000">50</option>
        <option value="150000">150</option>
        <option value="400000">400</option>
        <option value="800000">800</option>
        <option value="1000000">1000</option>
      </select>
      <p style="position:absolute; left:32%; top: 47.3%; right: 10px; font-weight: 300">km of city</p>
      <div id="popcutoff" style="position:absolute; left:12%; top: 53%; right: 10px; font-weight: 300">Minimum Pageviews: <span>10000</span></div>
      <input id="popslider" class="slider" type="range" min="0" max="50000" value="10000"
        step="2500" style="position:absolute; left:12%; top: 55.5%; right: 10px;">
      <div id="vertcutoff" style="position:absolute; left:12%; top: 59%; right: 10px; font-weight: 300">Minimum Vertical: <span>300</span></div>
      <input id="vertslider" class="slider" type="range" min="0" max="4950" value="300"
          step="150" style="position:absolute; left:12%; top: 62%; right: 10px;">
      </div>

      <p style='position:absolute;bottom:2%;left:20%; font-size: 80%'>Map Authored by Corin Zarkowski 2020</p>
    </div>
  </div>
  <script>
  function addUiListeners() {
    $('#sector').change(function() {
      sectorData = $(this).val();
      updateSymbols(sectorData, null, null);
    });

    $('#areacount').change(function() {
      areaData = $(this).val();
      distanceData = $('select[id="areadistance"]').val();
      updateCities(distanceData, areaData);
    });

    $('#areadistance').change(function() {
      distanceData = $(this).val();
      areaData = $('select[id="areacount"]').val();
      updateCities(distanceData, areaData);
    });

    $('#popslider')
      .on('input change', function() {
        popCutoff = $(this).val();
        updateSymbols(null, popCutoff, $('#vertslider').val());
        $('#popcutoff span').html(popCutoff);
    });

    $('#vertslider')
      .on('input change', function() {
        vertCutoff = $(this).val();
        updateSymbols(null, $('#popslider').val(), vertCutoff);
        $('#vertcutoff span').html(vertCutoff);
    });
  };

  function calcRadius(val) {
    var radius = Math.sqrt(val / Math.PI);
    return radius * .6;
  }

  function drawMap() {
    console.log('drawing map...');
    if(typeof(data) !== 'undefined'){
      data.removeFrom(skimap);
      delete data;
    }
    data = L.geoJson.ajax("assets/ski_geojson.json", {
      onEachFeature: function(feature, layer) {
        if(feature.properties.vertical){
          layer.bindPopup("<b>" + feature.properties.name + "</b> <br>Wikipedia Pageviews in 2020: " +
            feature.properties['pageviews-2020'] +
            " <br>Vertical Drop: " + feature.properties.vertical + " ft");
        } else{
          layer.bindPopup("<b>" + feature.properties.name + "</b> <br>Wikipedia Pageviews in 2020:  " +
            feature.properties['pageviews-2020'] +
            " <br>Vertical Drop: N/A");
        }
      },
      pointToLayer: function(feature, latlng) {
        var id = 0;
        var radius = calcRadius(feature.properties['pageviews-2020'] * .5);
        if(feature.properties['pageviews-2020'] > 10000) {
          var opacity = 1;
        } else {
          var opacity = 0;
        }
        return L.circleMarker(latlng, {
            color: '#8C029A',
            opacity: opacity,
            weight: .6,
            fillOpacity: 0,
            radius: radius
        });
      }
    }).addTo(skiLayer);

    dataCity = L.geoJson.ajax("assets/cities_sorted.geojson", {
      onEachFeature: function(feature, layer) { // TODO DELETE
        layer.bindPopup("<b>" + feature.properties.city_name + "</b>");
      },
      pointToLayer: function(feature, latlng) {
        var id = 0;
        return L.circleMarker(latlng, {
            color: '#000000',
            opacity: 1,
            weight: .6,
            fillOpacity: .3,
            radius: 5
        });
      }
    }).addTo(cityLayer);

    addUiListeners();
  };

  function updateCities(distanceCutoff, areaCutoff) {
    console.log("updating city markers...");
    console.log(areaCutoff, ", ", distanceCutoff);
    var coords;
    var skicoords;
    var cityname;
      dataCity.eachLayer(function(layer) {
        var areaCount = 0;
        var cityname = layer.feature.properties.city_name;
        coords = L.latLng(layer.feature.geometry.coordinates[1], layer.feature.geometry.coordinates[0]);
        data.eachLayer(function(layer) {
          skicoords = L.latLng(layer.feature.geometry.coordinates[1], layer.feature.geometry.coordinates[0]);
          if((skicoords.distanceTo(coords)) < distanceCutoff) {
            console.log("distance from", cityname, " to ", layer.feature.properties.name);
            console.log((L.latLng(layer.feature.geometry["coordinates"]).distanceTo(coords)));
            areaCount += 1;
          }
        })
        if(areaCount >= areaCutoff) {
          layer.setStyle({opacity: 1, fillOpacity: .3});
        } else {
          layer.setStyle({opacity: 0, fillOpacity: 0});
        }
      })
  }

  function updateSymbols(weight, popCutoff, vertCutoff, hideNullVert) {
    console.log("updating markers...");
    var radius;
    var color;
    var opacity;
      data.eachLayer(function(layer) {
        if(weight) {
          if(weight === "VIEWS"){
            radius = calcRadius(layer.feature.properties["pageviews-2020"]) * 0.5;
            color = '#8C029A';
          } else if(weight === "VERT"){
            if(layer.feature.properties['vertical']){
              radius = Math.pow(calcRadius(layer.feature.properties['vertical']), 2) / 10;
              color = '#8C029A';
            } else {
              radius = 5;
              color = '#028a00';
              opacity = 1;
              layer.setStyle({opacity: opacity});
            }
          }
          layer.setStyle({color: color});
          layer.setRadius(radius);
        } else if(popCutoff) {
          if(layer.feature.properties['vertical'] !== 'undefined') {
            if(layer.feature.properties['pageviews-2020'] >= popCutoff && parseInt(layer.feature.properties['vertical']) >= vertCutoff) {
              layer.setStyle({opacity: 1});
            } else {
              layer.setStyle({opacity: 0});
            }
          } else {
            if(layer.feature.properties['pageviews-2020'] >= popCutoff) {
              layer.setStyle({opacity: 1});
            } else {
              layer.setStyle({opacity: 0});
            }
          }
        }
      }).bringToFront();
  };

  var skiLayer = L.layerGroup([]);
  var cityLayer = L.layerGroup([]);

  var baseVoyager = L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}.png', {
      attribution: 'Wikipedia  | Base Map &copy; CartoDB | Made By Corin Zarkowski with help from Bo Zhao'
    });

  drawMap();
  var skimap = L.map('map', {
    center: [38, -100],
    zoom: 5,
    maxZoom: 10,
    minZoom: 3,
    detectRetina: true,
    layers: [baseVoyager, skiLayer, cityLayer]
  });

  L.control.scale({
    position: 'bottomleft'
  }).addTo(skimap);

  var baseMaps = {
    "Basemap": baseVoyager
  }
  var overlayMaps = {
    "Ski Areas": skiLayer,
    "Cities": cityLayer
  }

  L.control.layers(baseMaps, overlayMaps, {
    position: 'topright'
  }).addTo(skimap);

  </script>
</body>

</html>
